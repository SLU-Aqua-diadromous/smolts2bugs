<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to smolts2bugs • smolts2bugs</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to smolts2bugs">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">smolts2bugs</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/smolts2bugs.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to smolts2bugs</h1>
            
      

      <div class="hidden name"><code>smolts2bugs.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The model used to estimate smolt production is a Bayesian model
written in the BUGS-language and is run in the Blackbox environment. The
input for the model must be saved in a number of <em>.odc</em> files.
Odc files is a binary format and cannot be (easily) be written from R.
The format of the input is quite hard to create correctly by hand with
large matrix and column names that must be in a specific format to be
recognized.</p>
<p>To help the process <em>smolts2bugs</em> contains functions that can
format capture/recapture data and save an Excel-file where each sheet
corresponds to one Blackbox input file. The Blackbox .odc files can the
be created by cut-n-paste between Excel and Blackbox.</p>
</div>
<div class="section level2">
<h2 id="how-to-use-sötebasen-data">How to use Sötebasen data<a class="anchor" aria-label="anchor" href="#how-to-use-s%C3%B6tebasen-data"></a>
</h2>
<p>The prefered dataflow is to first have quality assured data in
Sötebasen. The package Smoltreg have routines to check for errors, clean
data and prepare a file for Sötebasen import. All data in Sötebasen with
<em>AnstrTyp == “Smoltfälla”</em> is regulary exported to CSV-files that
live in \\storage-dh.slu.se\restricted$\Sötebasen\Exporter.</p>
<p>This package (<em>smolts2bugs</em>) comes with functions to read
these files and format mark/recapture data to an excel-file that is very
close to the .ODC files that BlackBox needs. The package also comes with
a complete script that can be used for the preparation of Sötebasen data
to the Excelfile that can be used to cut-n-paste data into Blackbox.</p>
<div class="section level3">
<h3 id="get-the-script">Get the script<a class="anchor" aria-label="anchor" href="#get-the-script"></a>
</h3>
<p>To get a copy of the script run:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Save a script for the Sötebasen -&gt; BlackBox conversion</span></span>
<span><span class="fu">smolts2bugs</span><span class="fu">::</span><span class="fu"><a href="../reference/get_script.html">get_script</a></span><span class="op">(</span>scriptname <span class="op">=</span> <span class="st">"sote2bugs.R"</span><span class="op">)</span></span>
<span><span class="co"># see ?smolts2bugs::get_script for other options</span></span></code></pre></div>
<p>The recommended workflow is to load the script i Rstudio, adjust some
variables for your river, species and year and step through the code
while checking that you get reasonable data on each step. There are a
couple of places in the code where you need to make a decision on what
you want to do.</p>
<p>How to choose what fish to include?</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fish</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdb_read_catch_recatch.html">sdb_read_catch_recatch</a></span><span class="op">(</span>Art <span class="op">=</span> <span class="va">species</span>, VattenNamn <span class="op">=</span> <span class="va">river</span>, Year <span class="op">=</span> <span class="va">year</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu">between</span><span class="op">(</span><span class="va">Längd1</span>, <span class="va">minlength</span>, <span class="va">maxlength</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Längd1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#    filter(StadiumKod %in% c("S1", "S2", "S3") | Behandling == "Återfångad&amp;utsatt")</span></span></code></pre></div>
<p>This code reads all fish of one species for one river and year.
Historically we have used the fish length to choose only fish between a
min and max. But in 2023 in Ljungan we tried to use smoltification
status, assesed by field personel, to choose fish.</p>
<p>How to choose start and stop date? In Sötebasen we get start and stop
date for the trapping period but sometimes we have long leading and/or
trailing period with zero catches. It may be useful to reduce the length
of the period as the run time of the model seems to be very dependant of
the number of days.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Uncomment the lines in this code and change the dates to reduce the length of</span></span>
<span><span class="co"># study period.</span></span>
<span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="va">dates</span> <span class="op">%&gt;%</span></span>
<span><span class="co">#  mutate(AnstrDatumStart = as.Date("2023-05-11"),</span></span>
<span><span class="co">#         AnstrDatumSlut = as.Date("2023-06-22")) %&gt;% # Don't use long period of leading and trailing zero catch</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>N_days <span class="op">=</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">AnstrDatumSlut</span> <span class="op">-</span> <span class="va">AnstrDatumStart</span><span class="op">)</span>,</span>
<span>         start_day_of_year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXlt</a></span><span class="op">(</span><span class="va">AnstrDatumStart</span><span class="op">)</span><span class="op">$</span><span class="va">yday</span>,</span>
<span>         start_date <span class="op">=</span> <span class="va">AnstrDatumStart</span>,</span>
<span>         stop_date <span class="op">=</span> <span class="va">AnstrDatumSlut</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">N_days</span>, <span class="va">start_day_of_year</span>, <span class="va">start_date</span>, <span class="va">stop_date</span><span class="op">)</span></span></code></pre></div>
<p>The script will the assemble and format the data in BlackBox-format.
Formated data is saved in a separate folder under your current working
directory (<em>getwd()</em>). The script also saves RData_dump.Rdata
with both data and meta data and a Rmarkdown file
(_results_river_species_year.Rmd). The rmarkdown file can procduce a
human readable version of the results when the moddel is run and results
saved.</p>
</div>
</div>
<div class="section level2">
<h2 id="description-of-smolts2bugsformat_data2">Description of <em>smolts2bugs::format_Data2()</em>?<a class="anchor" aria-label="anchor" href="#description-of-smolts2bugsformat_data2"></a>
</h2>
<p>The bulk of the work is done by the function format_Data2() that will
create the matrix that should go into Data2_1group.odc. Step one is to
create a data.frame where each row represents one fish. The data.frame
<em>must</em> contain three manatory columns <em>capture_day</em>,
<em>recapture_day</em> and <em>marked</em>. Columns
<em>capture_day</em>, <em>recapture_day</em> are the day number the fish
was caught with the first day of the experiment is 1. Column
<em>marked</em> is a logical indicating if the fish was marked (subject
for recapture) or not. The parameter <em>env</em> is a data.frame with
two mandatory columns “water_temp” and “water_level”. The number of rows
in <em>env</em> must be equal to parameter <em>ndays</em> that indicates
how many days the experiment was running. The optional parameter
<em>missing_days</em> is a numerical vector of day numbers where the
trap wasn’t operational.</p>
<p>Below is a small data set demonstrating an experiment with 5 fishing
days where 3 fish was caught, 2 of those were marked and both marked
fish were recaptured. The result is a matrix with dimensions ndays x
ndays + 6.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://slu-aqua-diadromous.github.io/smolt2bugs/" class="external-link">smolts2bugs</a></span><span class="op">)</span></span>
<span><span class="va">ndays</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="op">(</span><span class="va">smolts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>   capture_day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span>,</span>
<span>   recapture_day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>   marked <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   capture_day recapture_day marked</span></span>
<span><span class="co">#&gt; 1           2            NA  FALSE</span></span>
<span><span class="co">#&gt; 2           2             3   TRUE</span></span>
<span><span class="co">#&gt; 3           3             4   TRUE</span></span>
<span><span class="op">(</span><span class="va">envdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>   w_temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">7</span>, <span class="fl">8</span>, <span class="fl">8.5</span>, <span class="fl">9</span><span class="op">)</span>,</span>
<span>   w_level <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">110</span>, <span class="fl">105</span>, <span class="fl">150</span>, <span class="fl">145</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   w_temp w_level</span></span>
<span><span class="co">#&gt; 1    7.0     100</span></span>
<span><span class="co">#&gt; 2    7.0     110</span></span>
<span><span class="co">#&gt; 3    8.0     105</span></span>
<span><span class="co">#&gt; 4    8.5     150</span></span>
<span><span class="co">#&gt; 5    9.0     145</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_Data2.html">format_Data2</a></span><span class="op">(</span>fish <span class="op">=</span> <span class="va">smolts</span>, env <span class="op">=</span> <span class="va">envdata</span>, ndays <span class="op">=</span> <span class="va">ndays</span><span class="op">)</span></span>
<span><span class="va">result</span></span>
<span><span class="co">#&gt;      m[,1] c[,1] r[,1,1] r[,2,1] r[,3,1] r[,4,1] r[,5,1] wt[,1] wl[,1] z[,1]</span></span>
<span><span class="co">#&gt; [1,]     0     0       0       0       0       0       0    7.0    100     0</span></span>
<span><span class="co">#&gt; [2,]     1     2       0       0       1       0       0    7.0    110     0</span></span>
<span><span class="co">#&gt; [3,]     1     1       0       0       0       1       0    8.0    105     0</span></span>
<span><span class="co">#&gt; [4,]     0     0       0       0       0       0       0    8.5    150     0</span></span>
<span><span class="co">#&gt; [5,]     0     0       0       0       0       0       0    9.0    145     0</span></span>
<span><span class="co">#&gt;      n[,1]</span></span>
<span><span class="co">#&gt; [1,]     0</span></span>
<span><span class="co">#&gt; [2,]     0</span></span>
<span><span class="co">#&gt; [3,]     0</span></span>
<span><span class="co">#&gt; [4,]     0</span></span>
<span><span class="co">#&gt; [5,]     0</span></span></code></pre></div>
<p>The formated matrix should the be written to an Excel file using the
function <em>save_bugsdata()</em>. This will create a file with 6 sheets
<em>Data1</em>, <em>Data2</em>, <em>Inits1c1</em>, <em>Inits1c2</em>,
<em>Inits2c1</em> and <em>Inits2c2</em>. Each sheet corresponds to a
Blackbox .odc file. By default the file will be saved in the current
directory and be named <em>bugsdata.xlsx</em>. Existing file will be
overwritten.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/save_bugsdata.html">save_bugsdata</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span></code></pre></div>
<p>You can also save the data with R <em>save()</em> with the function
<em>save_Rdatadump()</em>, this file can later be loaded with
<em>load()</em>. Besides the smolt data <em>save_Rdatadump()</em> will
save various meta data describes the experiment. The data will be saved
as a list named <em>rdata</em>. By default the file will be saved in the
current directory and be named <em>RData_dump.RData</em>. Existing file
will be overwritten.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/save_Rdatadump.html">save_Rdatadump</a></span><span class="op">(</span><span class="va">result</span>, river <span class="op">=</span> <span class="st">"Mörrumsån"</span>, species <span class="op">=</span> <span class="st">"Lax"</span>,</span>
<span>               startd <span class="op">=</span> <span class="st">"2020-03-15"</span>, stopd <span class="op">=</span> <span class="st">"2020-05-20"</span>,</span>
<span>               missing_days <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">15</span><span class="op">:</span><span class="fl">18</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Anders Kagervall.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
